---
title: "ECO353 Data Project #1 - NBA Player Salaries and Team Winning Percentage (%)"
author: Jared Madarang and Jeffrey Chu
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r, include = FALSE}
install.packages("tidyverse")
install.packages("jtools")
install.packages("collapse")
install.packages("RCurl")
install.packages("corrplot")
install.packages("dplyr")
install.packages("ineq")
install.packages("DescTools")
install.packages("huxtable")
install.packages("scales")
library(tidyverse)
library(jtools)
library(collapse)
library(RCurl)
library(corrplot)
library(dplyr)
library(ineq)
library(DescTools)
library(huxtable)
library(scales)
```

# 1.0 Data Collection

**NBA Player Salaries (1984-2017)**

```{r}
url <- getURL("https://raw.githubusercontent.com/jeffreychu48/ECO353/refs/heads/main/salaries_1985to2018.csv")
nba.salaries <- read.csv(text = url)
nba.salaries <- nba.salaries %>% select(team, playerid, salary, seasonstart)
```

**NBA Team Winning Percentage (1980-2017)**

```{r}
url <- getURL("https://raw.githubusercontent.com/jeffreychu48/ECO353/refs/heads/main/nba_team_win.csv")
nba.teamwin <- read.csv(text = url)
nba.teamwin <- nba.teamwin %>% select(team, record, winpercent, seasonstart)
```


## Team Salary Distribution (1984-2017)

**Total and Average Team Salary by team and seasonstart**
  
```{r}
#Total Team Salary per Year, by Team
nba.salaries.team <- nba.salaries %>%
  group_by(team, seasonstart) %>%
  mutate(totalteamsalary = sum(salary, na.rm = TRUE)) %>%
  ungroup()

#Average Team Salary per Year, for all Teams
nba.salaries.team <- nba.salaries.team %>%
  group_by(seasonstart) %>%
  mutate(averagetotalteamsalary = mean(totalteamsalary, na.rm = TRUE)) %>%
  ungroup()
```


## Accounting for Salary Cap increases and Irregular Contracts

**Salary Cap**

We need to select a time period that has steady salary cap increases, as salary distribution is ultimately determined by the NBA salary cap. 

```{r, fig.height=3}
ggplot(data = nba.salaries.team, aes(x = seasonstart, y = averagetotalteamsalary)) +
  geom_point(size = 2) +
  geom_line(color = "black", linewidth = 0.8) +
  scale_y_continuous(labels = label_number(big.mark = ",", decimal.mark = ".")) +
  ggtitle("Average Team Salary from 1984 to 2017")
```

The most notable jump occurs around 2015-2017, which corresponds to the new NBA TV deal kicking in, causing a sudden spike in the salary cap.

The average total team salary seems to be relatively steady from 2000 to 2015, which is the 15-year period that will be used to investigate further. 

```{r}
#Filtering for 2000-2015 to control for Salary Cap
nba.salaries.team.2000to2015 <- nba.salaries.team %>% 
  filter(seasonstart >= 2000 & seasonstart <= 2015)
```

**Irregular Contracts**

```{r}
#Arranging data by lowest salaries
nba.salaries.team.2000to2015 %>% 
  arrange(salary) %>% 
  head(nba.salaries.team.2000to2015, n=2)
```

It is observed that salaries that are below the minimum salary for each respective season. For example, the second player on this list, "jonesda02", is 12-year NBA veteran Dahntay Jones, who only has a salary of only $8,819 for the 2015 season on the Cavaliers. Per his basketball reference page (https://www.basketball-reference.com/players/j/jonesda02.html), he only appeared once for the Cavs. After researching further, it's realized that he signed with the Cavs before the last game of the regular season.

Using this example, it is fair to assume that there are many irregular signings that don't last the whole year, which will cause major deviations in salary distribution for teams. While calculating salary distribution by using the Gini coefficient, it is imperative to eliminate these deviations.To account for this, a salary of floor of $300,000 is enforced (which is around the rookie minimum contract in the year 2000). Found at: https://www.spotrac.com/nba/cba/minimum 

```{r}
#Filtering out player salaries < $300,000
nba.salaries.team.2000to2015 <- nba.salaries.team.2000to2015 %>% 
  filter(salary >= 300000)
```


## Gini coefficient by team and seasonstart

Salary Distribution quantified by using the Gini coefficient. This statistical measure captures the degree of inequality in salary allocation within a fixed 0 â€“ 1 range : a coefficient of zero represents perfect equality (all players earning the same salary), whereas a coefficient closer to one reflects extreme concentration of salary among a small number of players. By applying the Gini coefficient to each team, the analysis quantifies the extent to which compensation structures reflect a star-dominated or more balanced approach. 

```{r}
gini.2000to2015 <- nba.salaries.team.2000to2015 %>% 
  group_by(team, seasonstart) %>%   
  summarise(
    gini = Gini(salary, na.rm = TRUE),
    totalteamsalary = max(totalteamsalary), 
    averagetotalteamsalary = max(averagetotalteamsalary), 
    .groups = "drop") %>%
  arrange(seasonstart, team) 
```

```{r}
gini.2000to2015 <- gini.2000to2015 %>% 
  arrange(desc(gini)) %>% 
    drop_na(gini)
```

## Team Salary Distribution and Team Wins (2000-2015)

**Merging Team Wins to Team Gini dataset**
```{r, include = FALSE}
gini.wins.2000to2015 <- left_join(
  x = gini.2000to2015, 
  y = nba.teamwin, 
  by = c("team", "seasonstart"))

gini.wins.2000to2015 %>% head()
```


**Gini coefficient over Time**

```{r, fig.height=4}
ggplot(data = gini.wins.2000to2015, aes(x = seasonstart, y = gini, color = team)) +
  geom_point(size = 2) +
  geom_smooth(method="lm", se = TRUE, color="black") +
  ggtitle("Gini Salary Coefficient from 2000 to 2015")
```

With the changes to account for salary cap and irregular contracts, this graphs shows that the gini coefficient is standardized over the years from 2000 to 2015, which is useful for analysis of salary distribution and team wins over this time period.

# 1.1 Team analysis

For the Miami Heat

**Filtering Dataset for the Miami Heat**
```{r}
gini.wins.2000to2015.heat <- gini.wins.2000to2015 %>% 
  filter(team == "Heat") %>% 
  arrange(desc(seasonstart))
```

```{r, include = FALSE}
# Miami Heat: Gini coefficient over Time
ggplot(data = gini.wins.2000to2015.heat, aes(x = seasonstart, y = gini)) +
  geom_point(size = 2) +
  geom_smooth(method="loess", se = TRUE, color="black") +
  geom_line(color = "red", linewidth = 0.8) +
  ggtitle("Miami Heat Gini Salary Coefficient over Time (2000 to 2015)")
```


```{r, include = FALSE}
# Miami Heat: Win Percent over Time\
ggplot(data = gini.wins.2000to2015.heat, aes(x = seasonstart, y = winpercent)) +
  geom_point(size = 2) +
  geom_smooth(method="loess", se = TRUE, color="black") +
  geom_line(color = "red", linewidth = 0.8) +
  geom_hline(yintercept = 0.5, 
             linetype = "dotted", 
             color = "blue",
             linewidth = 0.5) + 
  ggtitle("Miami Heat Win Percentage over Time (2000 to 2015)")
```

## Correlation between Team Wins and Gini Coefficient
```{r, fig.height=4.5}
ggplot(data = gini.wins.2000to2015.heat, aes(x = gini, y = winpercent)) +
  geom_point(aes(color = factor(seasonstart)), size = 3) +
  geom_text(
    aes(x = gini, y = winpercent, label = seasonstart),
    size = 3, vjust = -1, hjust = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 0.5) +
  ggtitle("Miami Heat Gini Salary Coefficient vs. Win Percentage")
```

## Regression of Miami Heat Wins and Gini Coefficient

```{r}
reg.2000to2015.heat <- lm(winpercent ~ gini, data=gini.wins.2000to2015.heat)
```


## Regression of Team Wins and Gini Coefficient, Holding Total Team Salary Constant

```{r}
reg.2000to2015.heat.salary <- lm(winpercent ~ gini + totalteamsalary, data=gini.wins.2000to2015.heat)
```

```{r}
export_summs(reg.2000to2015.heat, reg.2000to2015.heat.salary,
               model.names = c("Heat", "Heat holding Salary")
             )
```


# 1.2 League analysis

## Correlation between Team Wins and Gini Coefficient
```{r, fig.height=3}
ggplot(data = gini.wins.2000to2015, aes(x = gini, y = winpercent, color = seasonstart)) +
  geom_point(size = 2) +
  geom_smooth(method="lm", se = TRUE, color="black") +
  ggtitle("Gini Salary Coefficient vs. Win Percentage")
```

## Regression of Team Wins and Gini Coefficient

```{r}
reg.2000to2015 <- lm(winpercent ~ gini, data=gini.wins.2000to2015)
```


## Regression of Team Wins and Gini Coefficient, Holding Total Team Salary Constant

```{r}
reg.2000to2015.salary <- lm(winpercent ~ gini + totalteamsalary, data=gini.wins.2000to2015)
```

```{r}
export_summs(reg.2000to2015, reg.2000to2015.salary, 
               model.names = c("League","League holding Salary")
             )
```

# 1.3 The team in the context of the league

## Summary of Regression of Team Wins and Gini Coefficient

```{r}
export_summs(reg.2000to2015, reg.2000to2015.salary, reg.2000to2015.heat, reg.2000to2015.heat.salary,
               model.names = c("League","League holding Salary", "Heat", "Heat holding Salary")
             )
```

## Multiple Regression including OTHER FACTORS

NBA Division





